---
title: "Exercise 2 (20 minutes)"
subtitle: "When you're done, assist some of the others ..."
output: webexercises::webexercises_default
---

```{r setup, include = FALSE}
options(htmltools.dir.version = FALSE, servr.interval = 0.5, width = 115, digits = 2)
knitr::opts_chunk$set(
  collapse = TRUE, message = FALSE, 
  warning = FALSE, cache = FALSE,
  comment = "#", strip.white = TRUE)

library(webexercises)
```

```{r results = FALSE, echo = FALSE}
pacman::p_load(
  tidyverse, # Data manipulation,
  haven, # Handle labelled data.
  ggplot2, # beautiful figures,
  estimatr, # Regression for weighted data,
  essentials,
  modelr, 
  texreg) # regression tables with nice layout.

# 1. read the ESS round 9 data
ESS <- read_spss("../../../assets/ESS9e03_1.sav") %>%
  filter(cntry == "DK") %>% # Keep only the Danish data,
  # Keep only a minimum set of variables we need today,
  select(idno, pspwght, gndr, eduyrs, agea, 
         psppsgva, trstlgl, trstplc) %>%
  mutate(psppsgva = zap_labels(psppsgva), # Make numeric
         trstlgl = zap_labels(trstlgl), # Make numeric
         trstplc = zap_labels(trstplc), # Make numeric
         pspwght = zap_labels(pspwght), # Make numeric
         eduyrs = case_when( # Censor years of education at 9 & 21 years.
           eduyrs > 21 ~ 21,
           eduyrs < 9 ~ 9,
           TRUE ~ as.numeric(eduyrs)),
         gndr = as_factor(gndr)) %>% # Make factor
drop_na() # Delete cases with missing values.

# Run the regression and make a regression table.
mod1 <- lm_robust(trstlgl ~ eduyrs, data = ESS, weights = pspwght)
coef <- coef(mod1)["eduyrs"] %>% round(., 3) %>% as.scalar()
se <- vcov(mod1) %>% diag()
se <- se["eduyrs"] %>% sqrt() %>% round(., 3) %>% as.scalar()
```

1. Regress trust in the legal system on years of education. How much does a year-increase in education go along with a change in trust in politicians? `r fitb(coef, width = "5")` What is the estimated standard error of this $\hat{\beta}$? `r fitb(se, width = "5")`

`r hide("R solution -> dont' peak to early ;) !")`
```{r}
# Run the regression and make a regression table.
mod1 <- lm_robust(trstlgl ~ eduyrs, data = ESS, weights = pspwght)
screenreg(mod1, include.ci = FALSE, digits = 3)
```
`r unhide()`

2. Make a scatterplot that visualizes the linear relationship and also contains a 95% CI for the OLS line. Make sure to use weights and to express weights as size of the scattered dots.
`r hide("R solution -> dont' peak to early ;) !")`
```{r}
ggplot(data = ESS, aes(y = trstlgl, x = eduyrs)) +
  geom_jitter(aes(size = pspwght), alpha = 1/3, height = 0.1, width = 0.1) +
  geom_smooth(aes(weight = pspwght), method = "lm") +
  labs(y = "Trust in the legal system", x = "Years of education") +
  theme_minimal()
```
`r unhide()`

3. Regress trust in the legal system on gender and make a coefficient plot.
`r hide("R solution -> dont' peak to early ;) !")`
```{r}
# Run the regression and make a regression table.
lm_robust(trstlgl ~ gndr, data = ESS, weights = pspwght) %>%
  tidy() %>%
  mutate(term = case_when(
    term == "gndrFemale" ~ "Gender: \n Female",
    term == "(Intercept)" ~ "Intercept")) %>%
  ggplot(aes(y = estimate, x = term)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  labs(title = "Regression of trust in the legal system",
       x = "", y = expression(beta)) +
  theme_minimal()
```
`r unhide()`
