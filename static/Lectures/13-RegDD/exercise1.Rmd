---
title: "Exercise 1 (20 minutes)"
subtitle: "When you're done, assist some of the others ..."
output: webexercises::webexercises_default
---

```{r setup, include = FALSE}
options(
  htmltools.dir.version = FALSE,
  servr.interval = 0.5,
  width = 115,
  digits = 3)

knitr::opts_chunk$set(
  collapse = TRUE, message = FALSE, 
  warning = FALSE, cache = FALSE,
  comment = "#", strip.white = TRUE)

library(webexercises)
library(essentials)
```

In Uruguay, the government launched a massive anti-poverty program (PANES). Household eligibility was determined by a Predicted Income Score. If your score was below a specific threshold, you got the money. If you were slightly above, you got nothing. Did receiving this welfare check increase political support for the current government? This question was investigated by Marco Manacorda, Edward Miguel, and Andrea Vigorito. Here you get the original data to replicate their study: 

Manacorda, M., Miguel, E., & Vigorito, A. (2011). Government Transfers and Political Support. American Economic Journal: Applied Economics, 3(3), 1–28.

```{r results = FALSE}
pacman::p_load(
  tidyverse, # Data manipulation,
  ggplot2, # beautiful figures,
  modelsummary, # regression tables
  causaldata, # contains the data
  estimatr) # OLS regression

# Import data used in Manacorda, M., Miguel, E., & Vigorito, A. (2011). Government Transfers and Political Support. American Economic Journal: Applied Economics, 3(3), 1–28.
data("gov_transfers", package = "causaldata")
```

1. In these data `gov_transfers`, we have households with two adults. The running variable is `Income_Centered`, which is already centered around the threshold and meaured in logarithmic units relative to the threshold. That is, 0.01 means a family has an income 1% higher than the threshold. Plot `Support` (measured in "Both said Yes = 1", "One said No and one Yes = 0.5" and "Both said No = 1") against income. To help visualize the trend, add a vertical line at the cutoff (0) and use `geom_smooth()` with `method = lm` separately for both sides of the cutoff.

Does there appear to be a jump in support at the cutoff? `r mcq(c("No", answer = "Yes", "It is hard to say visually, but possibly"))`.

`r hide("R solution -> don't peak too early ;) !")`
```{r}
# We create a new logical variable to group the smoothing lines
gov_transfers <- gov_transfers %>% 
  mutate(rule = case_when(
    Income_Centered >= 0 ~ "Welfare", 
    TRUE ~ "No Welfare"))

ggplot(data = gov_transfers, aes(y = Support, x = Income_Centered)) +
  geom_jitter(alpha = 0.15, height = 0.02, width = 0) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  # We use the 'rule' variable to force ggplot to draw two separate lines
  geom_smooth(aes(group = rule), method = "lm") +
  labs(title = "Uruguay PANES Program",
       x = "Income relative to cutoff (0.01 ca. 1%)",
       y = "Support for the Government") +
  theme_minimal()
```
`r unhide()`

2. Visual inspection is subjective. Let's estimate the size of the jump using a parametric linear regression. Create a dummy variable called `D` that is 1 if `Income_Centered` < 0, and 0 otherwise. Run OLS predicting `Support` using the treatment dummy and the running variable `Income_Centered`. What is the local effect of the welfare program? `r fitb(0.1, width = "3")` Is it statistically significant? `r mcq(c("No", answer = "Yes"))`. What does the estimate tell us had the Government chosen a much higher threshold? `r mcq(c("Since more household would have benefitted, the effect would have been larger", answer = "We do not know, the estimate is local"))`.

`r hide("R solution -> don't peak too early ;) !")`
```{r}
# 1. Prepare the data
gov_transfers <- gov_transfers %>% 
  mutate(
    D = case_when(
    Income_Centered < 0 ~ 1,
    TRUE ~ 0)) 

# 2. Run the regression
RDD <- lm_robust(Support ~ D*Income_Centered, data = gov_transfers)

modelsummary(list("Support for the Government" = RDD), stars = TRUE,
             gof_map = c("nobs", "r.squared"), output = "gt")
```
`r unhide()`

