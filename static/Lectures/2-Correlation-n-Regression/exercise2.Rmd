---
title: "Exercise 2 (20 minutes)"
subtitle: "When you're done, assist some of the others ..."
output: webexercises::webexercises_default
---

```{r setup, include = FALSE}
options(htmltools.dir.version = FALSE, servr.interval = 0.5, width = 115, digits = 2)
knitr::opts_chunk$set(
  collapse = TRUE, message = FALSE, 
  warning = FALSE, cache = FALSE,
  comment = "#", strip.white = TRUE)

library(webexercises)
library(essentials)

pacman::p_load(
  tidyverse, # Data manipulation,
  ggplot2, # beautiful figures,
  wbstats, # download data from Worldbank. Tremendous source of global socio-economic data.
  estimatr, # OLS with robust SE,
  vdemdata, # Use varieties of democracy data, #<<
  countrycode, # Easy recodings of country names,
  modelsummary, # regression tables with nice layout,
  remotes) # Install beta version packages from GitHub.

# 1. V-Dem data
(Dat_vdem <- vdem %>% # The data are part of the package we loaded earlier
    as_tibble() %>% # turn into a tiblle
    select(country_name, country_text_id, year, v2xcl_rol) %>%
    rename(equal_liberty = v2xcl_rol, # rename liberty variable
           country = country_name) %>% #rename country variable
    select(-country)) # Drop the country variable !!

# 2. Download poverty data: <US$2.15 per day
(Dat_poverty <- wb_data("SI.POV.DDAY", # Download poverty data: <$2.15 per day, #<<
                        start_date = 1972, end_date = 2025) %>% #<<
   rename(poverty = SI.POV.DDAY, # rename poverty variable,
          year = date, # rename year variable,
          country_text_id = iso3c) %>% # rename country abbreviation,
   select(country_text_id, year, country, poverty) %>% # Keep only 3 variables
   drop_na(poverty) %>% # Drop cases with missing data,
   group_by(country) %>% filter(year == max(year)) %>% ungroup()) # Keep the most recent poverty statistic per country.

# 3. Join V-dem and Worldbank data
Dat <- inner_join(Dat_poverty, Dat_vdem, by = c("country_text_id", "year"))

# 4. Code socialism index
Dat <- Dat %>% mutate(socialist = case_when( # Years socialist minus years since,
  country == "China" ~ year - 1949,
  country == "Viet Nam" ~ year - 1945,
  country == "Algeria" ~ year - 1962,
  str_detect(country,"Portugal|Bangladesh") ~ year - 1972,
  country == "Guinea-Bissau" ~ year - 1973,
  country == "India" ~ year - 1976,
  country == "Nicaragua" ~ year - 1979,
  country == "Sri Lanka" ~ year - 1978,
  country == "Tanzania" ~ year - 1964,
  country == "Albania" ~ (1992 - 1944) - (year - 1992),
  str_detect(country, "Angola|Cabo Verde|Madagascar") ~ (1992 - 1975) - (year - 1992),
  str_detect(country,"Belarus|Bulgaria") ~ (1990 - 1946) - (year - 1990),
  str_detect(country, "Benin|Mozambique") ~ (1990 - 1975) - (year - 1990),
  country == "Chad" ~ (1975 - 1962) - (year - 1975), country == "Congo, Rep." ~ (1992 - 1970) - (year - 1992),
  country == "Czech Republic" ~ (1990 - 1948) - (year - 1990), country == "Djibouti" ~ (1992 - 1981) - (year - 1992),
  country == "Ethiopia" ~ (1991 - 1974) - (year - 1991), country == "Ghana" ~ (1966 - 1960) - (year - 1966),
  country == "Guinea" ~ (1984 - 1958) - (year - 1984), country == "Hungary" ~ (1989 - 1949) - (year - 1989),
  country == "Iraq" ~ (2005 - 1958) - (year - 2005), country == "Mali" ~ (1991 - 1960) - (year - 1991),
  country == "Mauritania" ~ (1978 - 1961) - (year - 1978), country == "Mongolia" ~ (1992 - 1924) - (year - 1992),
  country == "Myanmar" ~ (1988 - 1962) - (year - 1988), country == "Poland" ~ (1989 - 1945) - (year - 1989),
  country == "Romania" ~ (1989 - 1947) - (year - 1989), country == "Russian Federation" ~ (1991 - 1922) - (year - 1991),
  country == "Seychelles" ~ (1991 - 1977) - (year - 1991), country == "Senegal" ~ (1981 - 1960) - (year - 1981),
  country == "Sierra Leone" ~ (1991 - 1978) - (year - 1991), country == "Somalia" ~ (1991 - 1969) - (year - 1991),
  country == "Sudan" ~ (1985 - 1969) - (year - 1985), country == "Syria" ~ (2012 - 1963) - (year - 2012),
  country == "Tunisia" ~ (1988 - 1964) - (year - 1988), country == "Ukraine" ~ (1991 - 1919) - (year - 1991),
  country == "Yemen, Rep." ~ (1991 - 1967) - (year - 1991), country == "Zambia" ~ (1991 - 1973) - (year - 1991),
  str_detect(country,"Slovenia|Croatia|Serbia|Montenegro|Bosnia and Herzegovina|North Macedonia|Kosovo") ~ (1992 - 1943) - (year - 1992),
  TRUE ~ 0),
  socialist = case_when( # Min. 5 years given socialist history,
    (socialist < 5 & socialist > 0) | socialist < 0 ~ 5,
    TRUE ~ socialist)) %>% drop_na() # Drop countries with missing values.
```

```{r echo = FALSE}
ols_1 <- lm_robust(data = Dat, formula = poverty ~ socialist)
ols_2 <- lm_robust(data = Dat, formula = poverty ~ equal_liberty)
```
1. Regress poverty on our socialism index. With one more year of socialist history, poverty changes by: `r fitb(round(coef(ols_1)[2], 2), width = "5")` percentage points (two digits).
`r hide("R solution -> dont' peak too early ;) !")`
```{r results = 'asis'}
# Estimate regression models.
ols_1 <- lm_robust(data = Dat, formula = poverty ~ socialist)
modelsummary(list("Poverty" = ols_1), # Nicely-formatted table.
             statistic = NULL, # Don't report stat. inference
             gof_map = c("nobs", "r.squared"))
```
`r unhide()`

2. Regress poverty on the index of equality and liberty rights. With a one unit-increase in equality and liberty rights, poverty changes by: `r fitb(round(coef(ols_2)[2], 2), width = "5")` percentage points (two digits).
`r hide("R solution -> dont' peak too early ;) !")`
```{r results = 'asis'}
# Estimate regression models.
ols_2 <- lm_robust(data = Dat, formula = poverty ~ equal_liberty)
modelsummary(list("Poverty" = ols_2), # Nicely-formatted table.
             statistic = NULL, # Don't report stat. inference
             gof_map = c("nobs", "r.squared")) 
```
`r unhide()`

3. Which of the two is a better model of the variance of poverty across the world?
`r mcq(c("The one with socialism", answer = "The one with equality and citizen rights, as the R2 shows", "The one with equality and citizen rights, as the stronger beta coefficient shows"))`

4. Make a scatterplot with civic and political citizenship rights on the Y-axis and socialism as predictor on the X-axis.
`r hide("R solution -> dont' peak too early ;) !")`
```{r out.width='100%', fig.height = 4, fig.width = 7.5, results = FALSE, echo = TRUE}
ggplot(data = Dat, aes(y = equal_liberty, x = socialist)) +
  geom_text(aes(label = country)) +
  labs(x = "Our socialism index", 
       y = "Index of equality before the law and individual liberty") +
  theme_minimal() +
  guides(color = "none")
```
`r unhide()`

```{r echo = FALSE}
ols <- lm_robust(data = Dat, formula = equal_liberty ~ socialist)
```

5. Regress the index of equality and liberty rights on socialism. With one more year of socialism, equality and liberty rights change by: `r fitb(round(coef(ols)[2], 2), width = "5")`
`r hide("R solution -> dont' peak too early ;) !")`
```{r results = 'asis'}
# Estimate regression models.
ols_3 <- lm_robust(data = Dat, formula = equal_liberty ~ socialist)
modelsummary(list("Equal & Liberty Rights" = ols_3), # Nicely-formatted table.
             statistic = NULL, # Don't report stat. inference
              gof_map = c("nobs", "r.squared")) 
```
`r unhide()`

6. Make a regression table that displays all three models. Based on the table, **discuss with your neighbor:** What do the results suggest about whether there is a freedom-equality trade off?
`r hide("R solution -> dont' peak too early ;) !")`
```{r results = 'asis'}
modelsummary(list("Poverty" = ols_1, "Poverty" = ols_2, "Equal & Liberty Rights" = ols_3), # Nicely-formatted table.
              gof_map = c("nobs", "r.squared")) 
```
`r unhide()`