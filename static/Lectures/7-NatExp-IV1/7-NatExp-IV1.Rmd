---
title: "Multiple Regression & <br><br> Fundamentals of Causal Inference"
subtitle: "<br>7. Natural Experiments & <br><br> Instrument Variables (IV)"
author: "Andrew Herman & Merlin Schaeffer<br> Department of Sociology"
date: "`r Sys.Date()`"
output: 
  xaringan::moon_reader:
    chakra: "../template/remark-latest.min.js"
    css: ["../template/Merlin169.css"]
    lib_dir: libs
    # self_contained: true
    nature:
      highlightLanguage: r
      highlightStyle: zenburn
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---
```{r setup, include = FALSE}
library(RefManageR)
library(knitr)
library(ggrepel) # Nicely placed labels in figures.
library(modelr)
library(webexercises) # Small web-based answer scales.
library(equatiomatic) # Regression equations from model objects.
library(essentials)

options(htmltools.preserve.raw = FALSE, tikzDefaultEngine = "xetex",
        htmltools.dir.version = FALSE, servr.interval = 0.5, width = 115, digits = 3)
knitr::opts_chunk$set(
  collapse = TRUE, message = FALSE, fig.retina = 3, error = TRUE,
  warning = FALSE, cache = FALSE, fig.align = 'center',
  comment = "#", strip.white = TRUE, tidy = FALSE)

BibOptions(check.entries = FALSE, 
           bib.style = "authoryear", 
           style = "markdown",
           hyperlink = FALSE,
           no.print.fields = c("doi", "url", "ISSN", "urldate", "language", "note", "isbn", "volume"))
myBib <- ReadBib("./../../../Stats_II.bib", check = FALSE)

xaringanExtra::use_xaringan_extra(c("tile_view", "tachyons"))
xaringanExtra::use_panelset()
```
# Goal of empirical sociology

.font130[.center[Use data to discover patterns, <br> and the .alert[social mechanisms that bring them about.]]]

```{r, echo = FALSE, out.width='65%', fig.align='center'}
knitr::include_graphics('https://researchleap.com/wp-content/uploads/2021/12/Population-data.jpeg')
```

???

Our goal is to move beyond simply describing correlations.

We want to understand the causal processes that create the social world we observe.

Today is about methods that help us get closer to that causal understanding.
---
class: inverse middle
# Today's schedule

1. **Today's 1st research question**: Terrorist attacks and xenophobia. 

2. **Natural Experiments**
  + RCTs versus Natural Experiments

3. **Today's 2nd research question:** Moving out of poor neighborhoods during early childhood.

4. **Intention to Treat (ITT)** Effects
  + RCTs versus ITTs

5. **Instrument Variables (IV)**
  - 3 IV requirements
  - First stage, reduced form, & Wald IV estimator
  - Why IV is LATE (local average treatment effect)

???
We'll start with a real-world question to introduce the idea of a Natural Experiment.

Then we'll look at a study to understand the problem of non-compliance in experiments.

This will lead us to the solution: Instrumental Variables, or IV.

---
# Terrorism and xenophobia

.push-left[
```{r, echo = FALSE, out.width='80%'}
knitr::include_graphics('https://cdn.britannica.com/25/74225-050-7F97DCE4/second-jetliners-terrorists-al-Qaeda-smoke-billows-crash-Sept-11-2001.jpg')
```


]

.push-right[
```{r, echo = FALSE, out.width='77.5%'}
knitr::include_graphics('https://cdn.britannica.com/33/129733-050-AF95D301/Smoke-flames-twin-towers-attacks-World-Trade-September-11-2001.jpg')
```
]

???

Let's begin with a difficult topic.

It's often claimed that major terrorist attacks like 9/11 change public opinion and social attitudes.

We want to investigate this claim empirically.

---
class: inverse middle center
# Today's 1st research question

.right-column[
```{r, echo = FALSE, out.width='60%'}
knitr::include_graphics('https://api.time.com/wp-content/uploads/2019/07/gettyimages-1064896696.jpg')
knitr::include_graphics('https://www.brookings.edu/wp-content/uploads/2019/07/Denmark.jpg?w=1200&h=630&crop=1')
```
]

--

.left-column[
.font130[
**What is the** 

**average causal effect**

**of terrorist attacks on xenophobia?**
]]

???

Notice the wording: "average causal effect." We want to know if the attacks cause a change in xenophobia.

---
# We need an RCT!

.push-left[
```{r, echo = FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('./img/randomization2.png')
```

If we *randomly* divide subjects into treatment and control groups, .alert[they come from the same underlying population]. 
    <br> <br> $\rightarrow$ They will be similar, on average, *in every way*;<br> **including their $Y_{0}$ ** (their potential outcome if not treated)!
    <br> <br> $\rightarrow E[Y_{0i}|D=1] = E[Y_{0i}|D=0]$!
    
**Beware**, in practice randomization can fail, especially if your sample is small.
]

.push-right[

$$\begin{equation}\begin{split} &  \underbrace{E[Y_{1i}|D=1] - E[Y_{0i}|D=0]}_{\text{Comparison between treatment and control group}} \\  \\ & = E[Y_{0i} + \color{red}{\kappa} |D=1] - E[Y_{0i}|D=0], \\ \\ &= \color{red}{\kappa} + \underbrace{E[Y_{0i} |D=1] - E[Y_{0i}|D=0]}_{\underbrace{0}_{\text{Selection bias (if randomization has worked)}}}, \\ \\ & = \underbrace{\color{red}{\kappa}.}_{\text{The average causal effect}} \end{split}\end{equation}$$
]

???

The ideal way: Randomized Controlled Trial (RCT).

Makes treatment and control groups comparable, on average, before treatment is applied.

This means their potential outcome without treatment $(Y_0)$ is the same.

This makes selection bias term go to zero, so the simple difference in outcomes between the groups is average causal effect, $\kappa$.

---
# But that is impossible and un-ethical!

.left-column[.center[
.alert[We cannot 

treat people with terrorism!]
]]

.right-column[
```{tikz, DAG1, echo = FALSE, out.width='70%', fig.ext = 'png', fig.retina = 3}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex,dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red] at (0,0) {$I$};
\node[state] (2) [right = of 1] {$D$};
\node[state] (3) [above = of 2] {$C$};
\node[state] (4) [right = of 2] {$Y$};

\path (1) [red] edge (2);
\path (2) edge (4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]

???

RCT is not an option here. We simply cannot randomly assign terrorism.

This is a common and fundamental challenge in sociology. Many of the "treatments" we care about are things we can't, or shouldn't, manipulate.

We need a different strategy.

---
class: inverse middle center
# Natural Experiments

???
It's a way of finding an RCT-like situation that has occurred naturally in the world.

---
class: clear
.left-column[
<br>

```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://news.harvard.edu/gazette/wp-content/uploads/2019/04/031319_Lewegie_103_2500.jpg')
```

### Merlin's friend Joscha 

### had an idea

]

.right-column[
```{r, echo = FALSE, out.width='60%'}
knitr::include_graphics('./img/Joscha1.png')
```
]

???

Joscha found a very clever way to study our research question. 

While he was a PhD student, he noticed something interesting about the timing of a major survey and a terrorist attack. 

This observation became the basis for a paper in one of the top sociology journals. 

---
# Natural experiments


.push-left[
**Natural experiment**: .alert[Random exposure] to treatment or control conditions are determined .alert[by nature], or by other factors outside the control of researchers.

In comparison to a normal RCT, this allows for:
> an experiment [...] on the grandest scale.

> -- `r Citet(myBib, "snow_mode_1856")`

.push-left[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Dr_John_Snow_%2824023399742%29.jpg/1280px-Dr_John_Snow_%2824023399742%29.jpg')
```
] 
.push-right[
```{r, echo = FALSE, out.width='68%'}
knitr::include_graphics('https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Pump_Handle_-_John_Snow_.jpg/450px-Pump_Handle_-_John_Snow_.jpg')
```
]]

.push-right[.center[
**The first natural experiment:** <br>
The cause of Cholera]
```{r, echo = FALSE, out.width='90%'}
knitr::include_graphics('https://i.guim.co.uk/img/static/sys-images/Guardian/Pix/pictures/2013/3/14/1363276040034/John-Snows-cholera-map-of-008.jpg?width=620&dpr=1&s=none&crop=none')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "snow_mode_1856")`]]
]

???

Exposure to the treatment is "as-if" random.

The classic example is John Snow's work on cholera in London. 

Because of how the water companies laid their pipes, the assignment was haphazard and not related to the residents' wealth or health.

This allowed him to compare death by water provider rates and identify the contaminated water pump as the source of the outbreak. 

---
# The 2002 Bali bombings

.left-column[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://www.iri.org/wp-content/uploads/2018/01/335017fda2a54fdc58700d83f73217c0.jpg?w=650')
knitr::include_graphics('https://dynaimage.cdn.cnn.com/cnn/c_fill,g_auto,w_1200,h_675,ar_16:9/https%3A%2F%2Fcdn.cnn.com%2Fcnnnext%2Fdam%2Fassets%2F201213212550-indonesia-bali-bombings-arrest-intl-hnk-file-101602.jpg')
```
]

.right-column[
<iframe src='https://en.wikipedia.org/wiki/2002_Bali_bombings' width='1000' height='600' frameborder='0' scrolling='yes'></iframe>
]

???

The event Legewie studied was the 2002 Bali bombings. 

It was a major terrorist attack that killed 202 people, many of whom were European tourists. 

This made the event highly salient across Europe, appearing on the front pages of newspapers everywhere.
---
# The natural experiment

```{r, echo = FALSE, out.width='60%'}
knitr::include_graphics('./img/Joscha2.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "legewie_terrorist_2013")`]]

???

Legewie uses the fact that the Bali attack occurred during the fieldwork period of the European Social Survey. 

The treatment and control groups are defined by the timing of their interview relative to the attack. 
--

.push-left[
.alert[Assumption 1]: The European Social Survey is based on random sampling. .alert[The day on which] $i$ .alert[was interviewed is also random!]

*Reachability bias*: Respondents who are easier to contact tend to be interviewed earlier during the survey period.
]

???
Assumption 1 is that the interview date is "as-if" random. Someone interviewed on Oct 11th is likely very similar to someone interviewed on Oct 13th. A potential threat to this is "reachability bias"

--

.push-right[
.alert[Assumption 2]: No other event at the time had a causal effect on $Y_{i}$.
]

???

Assumption 2 is that no other major, confounding event happened at the exact same time.

---
# Balance?

.left-column[
$$E[Y_{0i}|D=1] = E[Y_{0i}|D=0]?$$

```{tikz, ref.label = "DAG1", echo = FALSE, out.width='100%'}
```
]

.right-column[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('./img/Joscha3.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "legewie_terrorist_2013")`]]
]

???

How do we know if our "as-if" randomization worked? We can't be 100% sure, but we can check if the treatment and control groups are balanced on observable characteristics.

The plots show these balance checks for the data from Portugal. 

Plot 'a' shows the raw data. There's some minor imbalance; for example, the treatment group is slightly less likely to be retired. 

Ignore Plot 'b'

---
# RCTs vs Natural experiments

.push-left[.content-box-red[
.font120[.center[**Internal validity**]]

With an RCT, we control treatment assignment and thus know that the intervention $I$ was randomly assigned.

```{tikz, ref.label = "DAG1", echo = FALSE, out.width='70%'}
```
]]

???
RCTs have high internal validity. We know the treatment was randomized, so we are very confident in our causal estimate for the specific sample and setting.

--

.push-left[.content-box-blue[
.font120[.center[**External validity**]]

With a natural experiment, we can study a real event $E$ and not some artificial intervention $I$.
<br><br>

```{tikz, DAG2, echo = FALSE, out.width='70%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex,dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red] at (0,0) {$E$};
\node[state] (2) [right = of 1] {$D$};
\node[state] (3) [above = of 2] {$C$};
\node[state] (4) [right = of 2] {$Y$};

\path (1) [red] edge (2);
\path (1) [red, bidirected] edge ["?"] (3);
\path (2) edge (4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]]

???

Natural experiments often have higher external validity. We are studying a real-world event, not an artificial one, so the findings are more likely to be generalizable.

The cost is slightly lower internal validity. We have to assume the randomization (the event E is not caused by confounders C) rather than knowing it for sure.

---
# Natural experiments .font70[How to?!]

.left-column[.content-box-blue[
Analyzing a natural experiment does not necessarily involve much statistical sophistication; often simple OLS suffices.

*But finding one is as tough as finding truffles!*

.center[Are you such a <br>lucky truffle pig?]
]]

.right-column[
```{r, echo = FALSE, out.width='80%'}
knitr::include_graphics('https://upload.wikimedia.org/wikipedia/commons/5/5e/Cochon_truffier.JPG')
```
]

???

The key skill in using natural experiments is not complex statistical modeling.

The real challenge is having the creativity and deep knowledge of a subject to identify a situation in the world that provides "as-if" random assignment.

---
class: clear
# Learning goal 1 .font60[Terror attacks can increase xenophobia]

.right-column[
```{r, echo = FALSE, out.width='60%'}
knitr::include_graphics('./img/Joscha4.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "legewie_terrorist_2013")`]]
]

--

.left-column[.content-box-green[.center[
My friend Joscha <br> is a truffle pig ;)

Based on the idea that the day of a survey interview is random, he could estimate the causal effect of the Bali 2002 terror attack on xenophobic attitdes in several European countries.

But why was there an effect in Portugal, but not in the UK?

Read his article ;)
]]]

???

So, here's the payoff. This is our first learning goal.

Legewie's natural experiment shows that the Bali attack did have a causal effect, increasing anti-immigrant sentiment in Portugal, Poland, and Finland. 

But importantly, the effect was not universal. There was no significant effect in countries like Great Britain or the Netherlands. 

---
class: inverse middle center
# Break

<iframe src='https://panel.letstimeit.com/instant-timer/15-minute' width='600' height='400' frameborder='0' scrolling='yes'></iframe>


---
class: middle clear

.left-column[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://www.latentview.com/wp-content/uploads/2016/04/LatentView-Turns-Ten-A-decade-of-data-science.jpg')
```

<iframe src='https://panel.letstimeit.com/instant-timer/20-minute' width='600' height='400' frameborder='0' scrolling='yes'></iframe>

]

.right-column[
<br>
<iframe src='exercise1.html' width='1000' height='600' frameborder='0' scrolling='yes'></iframe>
]

---
layout: false
class: inverse middle center
# Break

<iframe src='https://panel.letstimeit.com/instant-timer/10-minute' width='600' height='400' frameborder='0' scrolling='yes'></iframe>


---
class: inverse middle center
# Intention to Treat (ITT) Designs

???

So far, the "treatment" was an event everyone was exposed to.

But what about experiments where people are offered a treatment, but not everyone accepts it? This brings us to Intention-to-Treat designs.

---
# .font80[One of the largest RCTs in the social sciences]

.left-column[
```{r, echo = FALSE, out.width='55%'}
knitr::include_graphics('https://s3.amazonaws.com/uploads.thirdway.org/legacy/publishing/images/files/000/000/955/NEXT_-_Moving_to_Opportunity_COVER_Web.jpg?1422480199')
```

```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://media.npr.org/assets/news/2010/12/06/chicago-176e8cb0fb2f87289bbda3bfd2b8b4f492fa572d-s1100-c50.jpg')
```
]

.right-column[
<iframe src='https://en.wikipedia.org/wiki/Moving_to_Opportunity' width='1000' height='600' frameborder='0' scrolling='yes'></iframe>
]

???

Our second example is the "Moving to Opportunity" or MTO experiment. 

This was a massive, real RCT conducted by the US government. 

4,600 low-income families in high-poverty public housing were randomly assigned to one of three groups. 

The key group received a housing voucher that they could only use to move to a low-poverty neighborhood, plus counseling to help them. 

This was designed to answer the fundamental question: Does your neighborhood determine your destiny?

---
layout: true
# Intention to treat (ITT) $\neq$ treatment

.left-column[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://i.ytimg.com/vi/3L8wc_Nd9kM/sddefault.jpg')
```

```{tikz, DAG3, echo = FALSE, out.width='100%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex,dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red] at (0,0) {$Z$};
\node[state] (2) [right = of 1] {$D$};
\node[state] (3) [above = of 2] {$C$};
\node[state] (4) [right = of 2] {$Y$};

\path (1) [red] edge ["0.4766"] (2);
\path (2) edge (4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]

???

Here's the critical complication in the MTO study: The experimenters randomly assigned the offer of a voucher. That's the Intention to Treat.

But they couldn't force people to move. The actual treatment is moving.

This table from Chetty, Hendren, and Katz's 2016 re-analysis of the MTO data shows that only 47.66% of families with young children who were offered the experimental voucher actually took it up and moved. 

This is called non-compliance. The randomly assigned variable, Z (the offer), is not the same as the treatment variable, D (moving).

---

.right-column[
```{r, echo = FALSE, out.width='80%'}
knitr::include_graphics('./img/Chetty_1.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "chetty_effects_2016")`]]
]

???

Now let's look at the long-term results on children's adult earnings.

Column 2 shows the "Intent-to-Treat" or ITT effect. For children under 13, being offered the voucher caused their adult earnings to be $1,624 higher. 

This is an important finding. But is this the causal effect of moving?

---

.right-column[
```{r, echo = FALSE, out.width='80%'}
knitr::include_graphics('./img/Chetty_2.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "chetty_effects_2016")`]]

.content-box-green[.center[
Is this \$1,624 increase the average causal effect of *moving*?
]]]

---

.right-column[
```{r, echo = FALSE, out.width='80%'}
knitr::include_graphics('./img/Chetty_2.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "chetty_effects_2016")`]]

.content-box-blue[

.center[Since support for moving out of poor neighborhoods was randomly assigned by a lottery...]

$\rightarrow$ The ITTs are average causal effects.

$\rightarrow$ But they are average causal effects .alert[of being offered support] $\color{red}{Z}$, <br>.alert[not of having moved to a better neighborhood] $\color{black}{D}$.alert[!]

]]

???

No, it's not.

Because the offer (Z) was randomized, the ITT of $1,624 is a valid causal effect. But it's the causal effect of being offered the program, not the effect of the treatment itself (moving).

The ITT effect is diluted. It's the average of a large effect for the 48% who moved and a zero effect for the 52% who were offered the voucher but stayed.

---
layout: false
# RCTs vs ITTs

.push-left[.content-box-red[
.font120[.center[**RCT**]]

$$\begin{equation}\begin{split} & |r_{I,D}| = 1 \\ &\rightarrow I = D! \end{split}\end{equation}$$

The correlation between intervention $I$ and predictor of interest $D$ is 1, making them practically the same thing.

```{tikz, DAG4, echo = FALSE, out.width='70%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex,dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red] at (0,0) {$I$};
\node[state] (2) [right = of 1] {$D$};
\node[state] (3) [above = of 2] {$C$};
\node[state] (4) [right = of 2] {$Y$};

\path (1) [red] edge ["$|r|=1$"] (2);
\path (2) edge (4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]]

???

In a perfect RCT with full compliance, the intervention is the treatment. I equals D.

--

.push-left[.content-box-blue[
.font120[.center[**ITT**]]

$$\begin{equation}\begin{split} & |r_{Z, D}| < 1 \\ &\rightarrow Z \neq D! \end{split}\end{equation}$$

The correlation between intervention $Z$ and predictor of interest $D$ is smaller than 1, which induces some random variation into $D$.


```{tikz, DAG5, echo = FALSE, out.width='70%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex, dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red] at (0,0) {$Z$};
\node[state] (2) [right = of 1] {$D$};
\node[state] (3) [above = of 2] {$C$};
\node[state] (4) [right = of 2] {$Y$};

\path (1) [red] edge ["$|r|<1$"] (2);
\path (2) edge (4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]]

???

In an ITT design with non-compliance, the randomly assigned variable Z (the "instrument" or "intention") is different from the treatment D. The correlation is less than one.

How do we get from the causal effect of Z to the causal effect of D?

---
layout: false
class: inverse middle center
# .font50[Fortunately, the Intervention (i.e. intention to treat) can be used as an:]<br> Instrument Variable (IV)

???

We can use the random assignment of the intention to treat as an "instrument" to isolate the causal effect of the treatment itself.

---
layout: true
# Instrument Variables (IV)

.push-left[
.content-box-blue[
.center[**Goal**]

Estimate causal effect $\lambda$ of treatment $D_{i}$ on outcome $Y_{i}$.
]
.content-box-red[
.center[**3 Requirements**]
1. *First stage*: Instrument $Z_{i}$ has causal effect $\phi$ on $D_{i}$.

2. *Randomization*: $Z_{i}$ is randomly assigned (RCT or natural experiment).

3. *Exclusion restriction*: $Z_{i}$ affects $Y_{i}$ **_only_** through its effect on $D_{i}$.
]]

---

.push-right[
```{tikz, DAG8, echo = FALSE, out.width='100%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex, dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red] at (0,0) {$Z$};
\node[state] (2) [right = of 1] {$D$};
\node[state] (3) [above = of 2] {$C$};
\node[state] (4) [right = of 2] {$Y$};

\path (1) [red] edge ["$\phi$"] (2);
\path (2) edge ["$\lambda$"](4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]

???

First, it must have a causal effect on the treatment D we're interested in. We can test this. In MTO, we saw that the voucher offer did indeed cause people to move.

Second, the instrument Z must be randomly assigned, or at least "as-if" random. This means it's uncorrelated with any confounders C. In MTO, this is true by design.

Third, and most critically, is the Exclusion Restriction. The instrument Z can only affect the outcome Y by going through the treatment D. There can be no other causal pathway.

---

.right-column[
.center[**Violated exclusion restriction**]
```{tikz, DAG6, echo = FALSE, out.width='80%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex,dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [red, align = center] at (0,0) {Win \\ lottery};
\node[state] (2) [right = of 1, align = center] {Moving out \\ of poverty};
\node[state] (3) [above = of 2, align = center] {E.g.\ optimistic \\ personality};
\node[state] (4) [right = of 2, align = center] {Income \\ as adult};

\path (1) edge ["0.4766"] (2);
\path (1) [red] edge ["?"] (3);
\path (2) edge (4);
\path (3) edge [red] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]

???

Let's think about how the Exclusion Restriction could be violated in the MTO study.

What if winning the housing lottery not only made you more likely to move, but also gave you a sense of hope or optimism?

And what if that optimism itself—a personality trait—helped your children succeed later in life, regardless of whether you moved or not?

This assumption is not testable; we have to argue for its plausibility.

---

.right-column[
.center[**"Instrumenting" the effect of interest**]
```{tikz, DAG7, echo = FALSE, out.width='80%'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,quotes}
\tikzset{
  -Latex,auto,node distance =1 cm and 1 cm,semithick,
  state/.style ={ellipse, draw, minimum width = 0.7 cm},
  point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
  bidirected/.style={Latex-Latex,dashed},
  el/.style = {inner sep=2pt, align=left, sloped}
}

\begin{tikzpicture}
\sffamily
\node[state] (1) [align = center] at (0,0) {Win \\ lottery};
\node[state] (2) [red, right = of 1, align = center] {Moving out \\ of poverty};
\node[state] (3) [above = of 2, align = center] {E.g.\ optimistic \\ personality};
\node[state] (4) [right = of 2, align = center] {Income \\ as adult};

\path (1) edge ["0.4766"] (2);
\path (2) [red] edge ["?"] (4);
\path (3) edge [dashed] (4);
\path (3) edge [dashed] (2);
\end{tikzpicture}
```
]

???

Assuming all requirements hold, let's build the intuition for how IV estimation works.

We want to find the causal effect of "Moving" on "Income," but we can't estimate it directly because of confounding.

---

.right-column[
.center[**"Instrumenting" the effect of interest**]
```{tikz, ref.label = "DAG7", echo = FALSE, out.width='80%'}
```

$$\underbrace{\kappa_{\text{Win lottery}\rightarrow\text{Moving}}}_{0.4766} \times \color{red}{\underbrace{\kappa_{\text{Moving}\rightarrow\text{Income}}}_{?}} = \underbrace{\kappa_{\text{Win lottery}\rightarrow\text{Income}}}_{1624\text{ Dollar}}$$

]

???

We can estimate two other effects cleanly.

First, the causal effect of winning the lottery on moving. That's the first stage, which is 0.4766.

Second, the causal effect of winning the lottery on income. That's the ITT or "reduced form" effect, which is $1624.

If the exclusion restriction holds, the reduced form effect must be equal to the first stage effect multiplied by the causal effect of moving on income.

---

.right-column[
.center[**"Instrumenting" the effect of interest**]
```{tikz, ref.label = "DAG7", echo = FALSE, out.width='80%'}
```


$$\begin{equation}\begin{split} \underbrace{\kappa_{\text{Win lottery}\rightarrow\text{Moving}}}_{0.4766} \times & \color{red}{\underbrace{\kappa_{\text{Moving}\rightarrow\text{Income}}}_{?}} = \underbrace{\kappa_{\text{Win lottery}\rightarrow\text{Income}}}_{1624\text{ Dollar}} \\ \\ & \color{red}{\underbrace{\kappa_{\text{Moving}\rightarrow\text{Income}}}_{?}} = \frac{\kappa_{\text{Win lottery}\rightarrow\text{Income}}}{\kappa_{\text{Win lottery}\rightarrow\text{Moving}}} \end{split}\end{equation}$$
]

???

We can rearrange this equation: The causal effect we want (Moving -> Income) is simply the reduced form effect (Lottery -> Income) divided by the first stage effect (Lottery -> Moving).

This is the fundamental logic of the IV estimator.
---
layout: false
# IV .font60[in general (The Wald Estimator)]

.push-left[
```{tikz, ref.label = "DAG8", echo = FALSE, out.width='70%'}
```

**First Stage:** $E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]; \text{call this }\phi.$

**Reduced Form:** $E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]; \text{call this }\rho.$

**IV Estimator:** $\lambda = \frac{\rho}{\phi} = \frac{E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]}{E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]}.$
]

--

.push-right[.content-box-blue[
.center[**The exclusion restriction matters!**<br>(but we cannot test it)]
```{tikz, ref.label = "DAG6", echo = FALSE, out.width='65%'}
```

$$\frac{1624}{0.4766} = \frac{\rho}{\phi} = \lambda \color{red}{+ ?}$$
.center[.alert[
If the exclusion restriction does not hold, <br> we additionally weigh-up other effects by $\frac{1}{\phi}$
]]]]

???

Here is the general formula, known as the Wald Estimator: The causal effect of interest, $\lambda$, is the ratio of the reduced form effect $\rho$ to the first-stage effect $\phi$.

For MTO, this is $1624 divided by 0.4766, which gives us about $3407.

---
layout: false
# IV is LATE .font60[Local Average Treatment Effect]

.push-left[
```{tikz, ref.label = "DAG8", echo = FALSE, out.width='70%'}
```

**First Stage:** $E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]; \text{call this }\phi.$

**Reduced Form:** $E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]; \text{call this }\rho.$

**IV Estimator of LATE:** $\lambda = \frac{\rho}{\phi} = \frac{E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]}{E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]} \color{red}{= E[Y_{1i}-Y_{0i}|\text{Complier}_{i}=1]}.$
]

.push-right[
```{tikz, Tree1, echo = FALSE, out.width='90%'}
\usetikzlibrary{trees}

\tikzset{
  el/.style = {inner sep=2pt, align=left, sloped},
  level distance=1.5cm,
  level 1/.style={sibling distance=6.5cm},
  level 2/.style={sibling distance=3cm},
  level 3/.style={sibling distance=1.5cm},
  node/.style={align=center,anchor=north}
}

\tikzstyle{bag} = [align=center]

\begin{tikzpicture}
  \node[bag] {Sample}
    child {node[bag] {Lottery\\winners\\$Z_{i}=1$}
      child {node[bag, red] {Moved \\ away}
        child {node[bag, red] {Compliers}}
        }
      child {node[bag] {Stayed}
        child {node[bag] {Never-\\taker}}
        child {node[bag] {Defiers}}
        }
    }
    child {node[bag] {Lottery \\ losers \\ $Z_{i}=0$}
    child {node[bag] {Moved \\ away}
      child {node[bag] {Defiers}}
      child {node[bag] {Always-\\taker}}
      }
      child {node[bag, red] {Stayed}
        child {node[bag, red] {Compliers}}
      }
    };
\end{tikzpicture}
```
]

???

But IV gives us the Local Average Treatment Effect, or LATE.

"Local" means it applies only to a specific subgroup:

Compliers: These are the people who follow their assignment. They move if they win the lottery and stay if they lose.

Never-takers: They will stay in their original neighborhood no matter what.

Always-takers: They will find a way to move to a better neighborhood, whether they win the MTO lottery or not.

Defiers: These are strange people who would move if they lose the lottery, but stay if they win.

---
layout: false
# IV is LATE .font60[Local Average Treatment Effect]

.push-left[
```{tikz, ref.label = "DAG8", echo = FALSE, out.width='70%'}
```

**First Stage:** $E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]; \text{call this }\phi.$

**Reduced Form:** $E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]; \text{call this }\rho.$

**IV Estimator of LATE:** $\lambda = \frac{\rho}{\phi} = \frac{E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]}{E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]} \color{red}{= E[Y_{1i}-Y_{0i}|\text{Complier}_{i}=1]}.$
]

.push-right[
```{tikz, ref.label = "Tree1", echo = FALSE, out.width='90%'}
```

**IV is LATE**: Never- & Always-taker don't respond to our intention to treat them. IV tells us nothing about them, but only about compliers.

**Monotonicity**: If there are defiers (& compliers),<br> IV produces garbage.
]

???

The IV estimator isolates the causal effect only for compliers!

Why? Because the behavior of never-takers and always-takers is the same regardless of whether they win the lottery. So their effects on the average outcome cancel out.

The only group whose behavior is changed by the lottery is the compliers.

This assumes no defiers! This is almost always a very reasonable assumption.

---
class: clear
# Learning goal 2 .font60[Moving kids out of poor nbhs improves their adult lifes!]

.left-column[
$\lambda = \frac{\rho}{\phi} = \frac{E[Y_{i}|Z_{i}=1]-E[Y_{i}|Z_{i}=0]}{E[D_{i}|Z_{i}=1]-E[D_{i}|Z_{i}=0]}.$

```{tikz, ref.label = "DAG8", echo = FALSE, out.width='70%'}
```
]
.right-column[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('./img/Chetty_3.png')
```
.center[.backgrnote[*Source:* `r Citet(myBib, "chetty_effects_2016")`]]
]

???

Using the housing voucher lottery as an instrumental variable, Chetty and colleagues estimated the LATE—the causal effect for complier families. 

Their key finding, shown in the TOT (Treatment-on-the-Treated) column, is that moving to a low-poverty neighborhood as a young child causes a substantial increase of about $3,477 in annual adult earnings. 

This provides powerful causal evidence that neighborhood environments during childhood have long-lasting effects.

---
layout: false
class: inverse middle center
# Break

<iframe src='https://panel.letstimeit.com/instant-timer/15-minute' width='600' height='400' frameborder='0' scrolling='yes'></iframe>



---
layout: true
# Zero-tolerance for domestic violence?

.push-right[
```{r, echo = FALSE, out.width='80%'}
knitr::include_graphics('https://images.theconversation.com/files/325865/original/file-20200406-6044-hao5gp.jpg?ixlib=rb-1.1.0&q=45&auto=format&w=1200&h=675.0&fit=crop')
knitr::include_graphics('https://indblik.dk/wp-content/uploads/2021/06/41648075864_b1450a1d67_k.jpg')
```
]

---

.push-left[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('./img/Domestic.png')
```
]

---

.push-left[
> [...] the pains of punishment deter people from repeating the crimes for which they are punished, especially when punishment is certain, swift and severe. 

.center[versus]

> [...] punishment often makes individuals more likely to commit crimes because of altered interactional structures, foreclosed legal opportunities and secondary deviance
> -- .center[.backgrnote[*Source:* `r Citet(myBib, "sherman_specific_1984")`]]

.center[**Does punishment increase repeat domestic abuse?**]
]

---
layout: false
class: middle clear

.left-column[
```{r, echo = FALSE, out.width='100%'}
knitr::include_graphics('https://www.latentview.com/wp-content/uploads/2016/04/LatentView-Turns-Ten-A-decade-of-data-science.jpg')
```

<iframe src='https://panel.letstimeit.com/instant-timer/20-minute' width='600' height='400' frameborder='0' scrolling='yes'></iframe>

]

.right-column[
<br>
<iframe src='exercise2.html' width='1000' height='600' frameborder='0' scrolling='yes'></iframe>
]

---
class: inverse
# Today's general lessons

1. *Natural Experiment*: A natural experiment is a situation in which people are randomly exposed to a treatment or control condition, without the intervention of a researcher. Compared to RCTs we have less control that exposure was truly random, but we can often study more interesting - real - events.

2. *Intention to Treat*: Intention-to-treat (ITT) analysis is a statistical method that compares the outcomes of people who were assigned to different treatment groups, regardless of whether they actually received the treatment. We thus estimate an average causal intention to treat effect, if we focus on the randomly assigned treatment alone.

3. *Instrument Variables (IV) Estimation*: Instrument variable regression allows us to recover the causal effect of the treatment (not the intention) in an intention to treat design.

4. *LATE (Local average treatment effect):* The LATE is the average treatment effect among people who would have complied with the treatment if they had been assigned to it. This is the Average Treatment Effect, but only for the "local" group of compliers. We learn the effect for those whose behavior was changed by the instrument, but we remain ignorant about the effect on never-takers and always-takers.

---
# References

.font80[
```{r ref1, results = 'asis', echo = FALSE}
PrintBibliography(myBib)
```
]

