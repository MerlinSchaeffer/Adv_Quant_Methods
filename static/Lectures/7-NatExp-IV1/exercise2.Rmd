---
title: "Exercise 2 (20 minutes)"
subtitle: "When you're done, assist some of the others ..."
output: webexercises::webexercises_default
---

```{r setup, include = FALSE}
options(htmltools.dir.version = FALSE, servr.interval = 0.5, width = 115, digits = 2)
knitr::opts_chunk$set(
  collapse = TRUE, message = FALSE, 
  warning = FALSE, cache = FALSE,
  comment = "#", strip.white = TRUE)

library(webexercises)
```

```{r eval = FALSE}
# Run this line of code once. 
# It downloads Data from Gelman & Hill's "Regression and other Stories"
remotes::install_github("avehtari/ROS-Examples", subdir = "rpackage")
```

```{r}
pacman::p_load(
  tidyverse, # Data manipulation,
  haven, # Handle Stata data.
  ggplot2, # beautiful figures,
  estimatr, # Regression for weighted data,
  furniture, # For row-means,
  modelsummary, # for balance tables,
  rosdata, # Data from Gelman & Hill's "Regression and other Stories"
  texreg) # regression tables with nice layout.

# Load the Sesame Street data
data(sesame)
sesame <- as_tibble(sesame) # Turn into tibble.
```

1. The variable `watched` indicates whether a kid actually watched Sesame Street. The variable `postlet` contains the results of the letter-recognition test. Did kids who watched Sesame Street perform better on the letter-recognition test? `r mcq(c("No, the result is not statistically significant", "No, the slope coefficient is actually negative", "Yes, the R2 is larger than 0.1", answer = "Yes, on average kids who whatched guessed ca. 13 letters more correctly and this is statistically significant", "Yes, we see three stars"))`. Is this evidence of an average causal effect? `r mcq(c("No, because there is no significant effect", "Yes, because the result is significantly positive", answer = "No, there could be selection bias into watching Sesame Street"))`.

`r hide("R solution -> dont' peak to early ;) !")`
```{r}
ols <- lm_robust(postlet ~ watched, data = sesame)
screenreg(ols, include.ci = FALSE, digits = 3)
```
`r unhide()`

2. The variable `encouraged` indicates whether a kid was randomly encouraged by its pædagog to watch Sesame Street. The variable `prelet` contains results from the same letter-recognition test, which the pædagogerne had conducted *before* they started to encourage kids to watch Sesame Street. Did the randomization of the encouragement work, or is there imbalance? `r mcq(c("Yes, the kids who got encouraged were already better at the test", "Yes, the kids who got encouraged were slightly worse at the test", answer = "No, while there is a difference of ca. 2 words on average, this difference is not 1.96 times it's standard error."))`.

`r hide("R solution -> dont' peak to early ;) !")`
```{r}
sesame %>%
  # Select variables for which I want my balance test,
  select(encouraged, prelet) %>%
  datasummary_balance( # Make a balance table,
    formula = ~ encouraged, # by Reading news Yes/No
    data = . ,
    title = "Correctly identified letters before encouragement, by encouragement") 
```
`r unhide()`

3. The variable `encouraged` indicates whether a kid was randomly encouraged by its pædagog to watch Sesame Street. Did kids who were encouraged to watch Sesame Street perform better on the letter-recognition test? `r mcq(c(answer = "No, the result is not statistically significant", "No, the slope coefficient is actually negative", "No, the R2 is smaller than 0.1", "Yes, on average kids who whatched guessed ca. 3 letters more correctly and this is statistically significant"))`. Is this evidence of an average causal effect? `r mcq(c("No, because not all kids who were encouraged actually watched", "No, correlation is not causation", answer = "Yes, but of being encouraged not of watching Sesame Street!"))`. In IV language, this is the `r mcq(c(answer = "Reduced form", "First stage", "LATE estimate"))`.

`r hide("R solution -> dont' peak to early ;) !")`
```{r}
ols2 <- lm_robust(postlet ~ encouraged, data = sesame)
screenreg(ols2, include.ci = FALSE, digits = 3)
```
`r unhide()`

4. How many kids complied to the encouragement? `r fitb(3.17, width = "4")` kids did. How much higher was the proportion of kids who watched Sesame Street among the encouraged kids compared to the non-encouraged kids? It was `r fitb(0.362, width = "4")` (three digits).
`r hide("R solution -> dont' peak to early ;) !")`. In IV language, this is the `r mcq(c("Reduced form", answer = "First stage", "LATE estimate"))`.
```{r}
# Make a table of absolute frequencies
(sesam_tab <- sesame %>% 
   select('watched','encouraged') %>% 
   table())

# Compliers are the encouraged who watched + the non-encouraged who didn't watch:
138 + 40

ols3 <- lm_robust(watched ~ encouraged, data = sesame)
screenreg(ols3, include.ci = FALSE, digits = 3)
```
`r unhide()`

5. Based on the above information, what is the IV estimate of the local average causal effect among complying kids? It is: `r fitb(7.94, width = "4")` (two digits).
`r hide("R solution -> dont' peak to early ;) !")`
```{r}
# The IV estimate is:
2.876  / 0.362
```
`r unhide()`

6. Install the following package: `install.packages("ivreg", dependencies = TRUE)`. Your can read about it here: [ivreg homepage](https://cran.r-project.org/web/packages/ivreg/vignettes/ivreg.html). Use the command `ivreg()` to estimate the IV Local Average Treatment Effect. Does watching Sesame Street make Kids better at XYZ? `r mcq(c(answer = "No, the LATE is not statistically significant", "Yes, the effect is positive"))`

`r hide("R solution -> dont' peak to early ;) !")`
```{r}
pacman::p_load(ivreg)
twosls <- ivreg(postlet ~ watched | encouraged, data = sesame)
screenreg(twosls)
```
`r unhide()`